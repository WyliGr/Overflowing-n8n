{
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        -864,
        -64
      ],
      "id": "81cfcb91-6f5f-4eb7-b8d6-daf5372b208f",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "operation": "formatDate",
        "date": "={{ $json.currentDate }}",
        "format": "yyyy-MM-dd",
        "outputFieldName": "formatted-url",
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        -864,
        160
      ],
      "id": "abb4c342-73d0-46bf-ac94-1607c4d96fe7",
      "name": "Formating"
    },
    {
      "parameters": {
        "jsCode": "const baseUrl = \"https://www.allocine.fr/_/showtimes/theater-P0963/d-\";\nconst formattedDate = $input.first().json['formatted-url']\nreturn [{\n  json: {\n    UGCUrl: baseUrl + formattedDate\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        -128
      ],
      "id": "525c9b43-e875-477d-8e2e-0ce001fb5727",
      "name": "UGC Link Builder"
    },
    {
      "parameters": {
        "jsCode": "const baseUrl = \"https://www.allocine.fr/_/showtimes/theater-P0026/d-\";\nconst formattedDate = $input.first().json['formatted-url']\nreturn [{\n  json: {\n    CosmosURL: baseUrl + formattedDate\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        16
      ],
      "id": "2fdfa00a-33f3-4a75-8397-45491fcc4ce4",
      "name": "Cosmos Link Builder"
    },
    {
      "parameters": {
        "jsCode": "const baseUrl = \"https://www.allocine.fr/_/showtimes/theater-P0600/d-\";\nconst formattedDate = $input.first().json['formatted-url']\nreturn [{\n  json: {\n    VoxURL: baseUrl + formattedDate\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -656,
        160
      ],
      "id": "b4e92f7c-e509-42d3-8ab7-277b38610d99",
      "name": "Vox Link Builder"
    },
    {
      "parameters": {
        "url": "={{ $json.UGCUrl }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -448,
        -128
      ],
      "id": "d1c559e9-b2b9-4144-9d0a-f3546cfc0929",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "url": "={{ $json.CosmosURL }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -480,
        16
      ],
      "id": "ab893038-48b9-48f2-acf3-36d0d860b4c8",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "url": "={{ $json.VoxURL }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -512,
        160
      ],
      "id": "cac5b062-410d-4afc-8a80-541acd797789",
      "name": "HTTP Request2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1072,
        112
      ],
      "id": "d7834147-ed53-44bf-beaa-fd9d80625a3f",
      "name": "When clicking ‚ÄòExecute workflow‚Äô"
    },
    {
      "parameters": {
        "jsCode": "const results = $input.first().json.results || [];\nconst nomDuCinema = \"UGC Cin√© Cit√©\"; // √Ä changer en \"Vox\" ou \"Le Cosmos\" selon le n≈ìud\n\nconst simplifiedData = results\n  .filter(item => item.showtimes?.multiple?.length > 0) // On vire les films sans s√©ances\n  .map(item => {\n    return {\n      titre: item.movie.title,\n      duree: item.movie.runtime,\n      horaires: item.showtimes.multiple.map(s => {\n        const date = new Date(s.startsAt);\n        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });\n      }).join(' | ')\n    };\n  });\n\nreturn [{ json: { cinema: nomDuCinema, films: simplifiedData } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        -128
      ],
      "id": "4585add2-704c-40c1-b1a4-8e22a33fb538",
      "name": "Simplify JSON"
    },
    {
      "parameters": {
        "jsCode": "const results = $input.first().json.results || [];\nconst nomDuCinema = \"Le Cosmos\"; // √Ä changer en \"Vox\" ou \"Le Cosmos\" selon le n≈ìud\n\nconst simplifiedData = results\n  .filter(item => item.showtimes?.multiple?.length > 0) // On vire les films sans s√©ances\n  .map(item => {\n    return {\n      titre: item.movie.title,\n      duree: item.movie.runtime,\n      horaires: item.showtimes.multiple.map(s => {\n        const date = new Date(s.startsAt);\n        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });\n      }).join(' | ')\n    };\n  });\n\nreturn [{ json: { cinema: nomDuCinema, films: simplifiedData } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        16
      ],
      "id": "97e96b19-866c-4e11-b9a2-c650bdd6531b",
      "name": "Simplify JSON1"
    },
    {
      "parameters": {
        "jsCode": "const results = $input.first().json.results || [];\nconst nomDuCinema = \"Vox\"; // √Ä changer en \"Vox\" ou \"Le Cosmos\" selon le n≈ìud\n\nconst simplifiedData = results\n  .filter(item => item.showtimes?.multiple?.length > 0) // On vire les films sans s√©ances\n  .map(item => {\n    return {\n      titre: item.movie.title,\n      duree: item.movie.runtime,\n      horaires: item.showtimes.multiple.map(s => {\n        const date = new Date(s.startsAt);\n        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });\n      }).join(' | ')\n    };\n  });\n\nreturn [{ json: { cinema: nomDuCinema, films: simplifiedData } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        160
      ],
      "id": "83dfc4ce-f303-48c9-a0c4-9064000c9566",
      "name": "Simplify JSON2"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 7
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -1072,
        -64
      ],
      "id": "d98148c6-bcd1-4288-9fd5-bb309f52efda",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un bot Discord minimaliste. Ta mission est de mettre en forme la liste de films suivante de mani√®re compacte et √©l√©gante : {{ JSON.stringify($json.liste_films) }}\n\n### CONSIGNE DE FORMATAGE STRICTE :\n\nPour chaque film avec une sc√©ance aujourd'hui, utilise exactement ce sch√©ma :\n\n**TITRE DU FILM** (Dur√©e)\n‚Ä¢ **Vox** : Horaires\n‚Ä¢ **UGC** : Horaires\n‚Ä¢ **Le Cosmos** : Horaires\n\n---\n\n### R√àGLES DE STYLE :\n1. N'affiche QUE les cin√©mas qui ont des s√©ances (si c'est \"Pas de s√©ance\", supprime la ligne).\n2. N'utilise PAS de titres de section (type ###) ou de s√©parateurs horizontaux (---).\n3. Utilise une puce simple (‚Ä¢) pour les cin√©mas.\n4. √âcris le titre du film en GRAS et MAJUSCULES.\n5. AUCUNE introduction, AUCUNE conclusion. Juste les films.\n6. Tu as le droit aux emojis, sans abus, reste minimaliste.\n7. Au d√©but de CHAQUE message, mets un GRAND TITRE avec la date pour s√©parer le message actuel et le message du jour pr√©c√©dent.\n8. N'√©cris RIEN D'AUTRE que le message discord. RIEN",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        80,
        112
      ],
      "id": "2ee973d8-72e7-409b-9c7e-fdce1ea93a59",
      "name": "AI Agent",
      "executeOnce": false
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "1470745724278018128",
          "mode": "list",
          "cachedResultName": "Better Will's Hub",
          "cachedResultUrl": "https://discord.com/channels/1470745724278018128"
        },
        "channelId": {
          "__rl": true,
          "value": "1474045417741353003",
          "mode": "list",
          "cachedResultName": "üìΩÔ∏è„Éªcinema",
          "cachedResultUrl": "https://discord.com/channels/1470745724278018128/1474045417741353003"
        },
        "content": "={{ $json.output }}",
        "options": {}
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        368,
        112
      ],
      "id": "be5e616a-b8c7-463a-9413-e210ede85202",
      "name": "Send a message",
      "webhookId": "39195e2f-43a6-4496-85c7-ae8e9cf4ee9f",
      "executeOnce": false,
      "credentials": {
        "discordBotApi": {
          "id": "LlFj0SCinffykm2S",
          "name": "Discord Bot account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -128,
        128
      ],
      "id": "bdc5a014-d6d2-4b53-964a-a738f6d97c56",
      "name": "Mistral Cloud Chat Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "gHnkztapowaO9uju",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const allInputs = $input.all();\nconst moviesMap = {};\n\nallInputs.forEach(input => {\n  const cinemaName = input.json.cinema;\n  const films = input.json.films || [];\n\n  films.forEach(film => {\n    const title = film.titre;\n    \n    if (!moviesMap[title]) {\n      moviesMap[title] = {\n        titre: title,\n        duree: film.duree,\n        seances: { \"Vox\": \"Pas de s√©ance\", \"UGC\": \"Pas de s√©ance\", \"Cosmos\": \"Pas de s√©ance\" }\n      };\n    }\n    \n    // On remplit le bon cin√©ma (petit check sur le nom)\n    if (cinemaName.includes(\"Vox\")) moviesMap[title].seances[\"Vox\"] = film.horaires;\n    if (cinemaName.includes(\"UGC\")) moviesMap[title].seances[\"UGC\"] = film.horaires;\n    if (cinemaName.includes(\"Cosmos\")) moviesMap[title].seances[\"Cosmos\"] = film.horaires;\n  });\n});\n\nreturn [{ json: { liste_films: Object.values(moviesMap) } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        -96
      ],
      "id": "98a47d98-859f-4c6f-8cbc-b8b2563e88c0",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -96,
        -112
      ],
      "id": "f0770916-890e-4ed3-9cd5-965b90b9d0e4",
      "name": "Merge"
    }
  ],
  "connections": {
    "Date & Time": {
      "main": [
        [
          {
            "node": "Formating",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formating": {
      "main": [
        [
          {
            "node": "UGC Link Builder",
            "type": "main",
            "index": 0
          },
          {
            "node": "Cosmos Link Builder",
            "type": "main",
            "index": 0
          },
          {
            "node": "Vox Link Builder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UGC Link Builder": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cosmos Link Builder": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vox Link Builder": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Simplify JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Simplify JSON1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Simplify JSON2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‚ÄòExecute workflow‚Äô": {
      "main": [
        [
          {
            "node": "Date & Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simplify JSON": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simplify JSON1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Simplify JSON2": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Date & Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5e90d789b48e5e14c97eedc713c1fb8d8fb2d7d72edbf19afa0f391e805bbe63"
  }
}